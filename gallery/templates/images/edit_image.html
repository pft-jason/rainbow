{% extends 'base.html' %}

{% load form_filters %}

{% block title %}Edit Image{% endblock %}

{% block content %}
<div class="container mt-5 mb-4">
    <!-- Bootstrap Card -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">Edit Image</h2>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                {% csrf_token %}

                <!-- Image Preview -->
                <div class="mb-4 text-center">
                    <img id="image-preview" src="{{ image.image.url }}" alt="Image Preview" class="img-fluid" style="max-width: 500px; height: auto;">
                </div>

                <!-- Image Field -->
                <div class="mb-4">
                    <label for="{{ form.image.id_for_label }}" class="form-label">{{ form.image.label }}</label>
                    {{ form.image|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please upload an image.
                    </div>
                </div>

                <!-- Title Field -->
                <div class="mb-4">
                    <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                    {{ form.title|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please provide a title for the image.
                    </div>
                </div>

                <!-- Description Field -->
                <div class="mb-4">
                    <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                    {{ form.description|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please provide a description.
                    </div>
                </div>

                <!-- Tags Section -->
                <div class="mb-3">
                    <label class="form-label">Age</label>
                    <div class="row">
                        {% for tag in form.tags.field.queryset %}
                            {% if tag.category == 'age' %}
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="tags" value="{{ tag.id }}" id="age-{{ tag.name|slugify }}" {% if tag in form.tags.value %}checked{% endif %}>
                                        <label class="form-check-label" for="age-{{ tag.name|slugify }}">
                                            {{ tag.name }}
                                        </label>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Body Tags Field -->
                <div class="mb-3">
                    <label class="form-label">Body</label>
                    <div class="row">
                        {% for tag in form.tags.field.queryset %}
                            {% if tag.category == 'body' %}
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="tags" value="{{ tag.id }}" id="body-{{ tag.name|slugify }}" {% if tag in form.tags.value %}checked{% endif %}>
                                        <label class="form-check-label" for="body-{{ tag.name|slugify }}">
                                            {{ tag.name }}
                                        </label>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Ethnicity Tags Field -->
                <div class="mb-3">
                    <label class="form-label">Ethnicity</label>
                    <div class="row">
                        {% for tag in form.tags.field.queryset %}
                            {% if tag.category == 'ethnicity' %}
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="tags" value="{{ tag.id }}" id="ethnicity-{{ tag.name|slugify }}" {% if tag in form.tags.value %}checked{% endif %}>
                                        <label class="form-check-label" for="ethnicity-{{ tag.name|slugify }}">
                                            {{ tag.name }}
                                        </label>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Interest Tags Field -->
                <div class="mb-3">
                    <label class="form-label">Interest</label>
                    <div class="row">
                        {% for tag in form.tags.field.queryset %}
                            {% if tag.category == 'interest' %}
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="tags" value="{{ tag.id }}" id="interest-{{ tag.name|slugify }}" {% if tag in form.tags.value %}checked{% endif %}>
                                        <label class="form-check-label" for="interest-{{ tag.name|slugify }}">
                                            {{ tag.name }}
                                        </label>
                                    </div>   
                                </div>  
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Official Tags Field (only for staff users) -->
                {% if form.official_tags %}
                <div class="card mx-4" style="background-color: #ffe5e5;"> <!-- Light red background -->
                    <div class="card-body">
                        <h5 class="card-title">Official Tags</h5>
                        <div class="row">
                            {% for tag in form.official_tags.field.queryset %}
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" name="official_tags" value="{{ tag.id }}" id="official-{{ tag.name|slugify }}" {% if tag in form.official_tags.value %}checked{% endif %}>
                                    <label class="form-check-label" for="official-{{ tag.name|slugify }}">
                                        {{ tag.name }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Submit Button -->
                <div class="text-center m-4">
                    <button type="submit" class="btn btn-primary btn-lg w-100">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Custom Bootstrap validation
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms)
        .forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()

    // Image preview
    document.getElementById('{{ form.image.id_for_label }}').addEventListener('change', function(event) {
        var reader = new FileReader();
        reader.onload = function() {
            var output = document.getElementById('image-preview');
            output.src = reader.result;
            output.style.display = 'block';
        };
        reader.readAsDataURL(event.target.files[0]);
    });
</script>
{% endblock %}
